name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_group:
          - "linux-amd64"
          - "linux-arm64"  
          - "linux-arm"
          - "darwin-amd64"
          - "darwin-arm64"
          - "windows-amd64"
          - "windows-arm64"
          - "freebsd-amd64"
          - "freebsd-arm64"
          - "openbsd-amd64"
          - "openbsd-arm64"
    steps:
    - name: Check Out Repo
      uses: actions/checkout@v4

    - name: Install Go
      uses: actions/setup-go@v5
      with:
        go-version: 1.24.x
        check-latest: true

    - name: Set build environment
      run: |
        case "${{ matrix.build_group }}" in
          "linux-amd64")
            echo "GOOS=linux" >> $GITHUB_ENV
            echo "GOARCH=amd64" >> $GITHUB_ENV
            ;;
          "linux-arm64")
            echo "GOOS=linux" >> $GITHUB_ENV
            echo "GOARCH=arm64" >> $GITHUB_ENV
            ;;
          "linux-arm")
            echo "GOOS=linux" >> $GITHUB_ENV
            echo "GOARCH=arm" >> $GITHUB_ENV
            echo "GOARM=7" >> $GITHUB_ENV
            ;;
          "darwin-amd64")
            echo "GOOS=darwin" >> $GITHUB_ENV
            echo "GOARCH=amd64" >> $GITHUB_ENV
            ;;
          "darwin-arm64")
            echo "GOOS=darwin" >> $GITHUB_ENV
            echo "GOARCH=arm64" >> $GITHUB_ENV
            ;;
          "windows-amd64")
            echo "GOOS=windows" >> $GITHUB_ENV
            echo "GOARCH=amd64" >> $GITHUB_ENV
            ;;
          "windows-arm64")
            echo "GOOS=windows" >> $GITHUB_ENV
            echo "GOARCH=arm64" >> $GITHUB_ENV
            ;;
          "freebsd-amd64")
            echo "GOOS=freebsd" >> $GITHUB_ENV
            echo "GOARCH=amd64" >> $GITHUB_ENV
            ;;
          "freebsd-arm64")
            echo "GOOS=freebsd" >> $GITHUB_ENV
            echo "GOARCH=arm64" >> $GITHUB_ENV
            ;;
          "openbsd-amd64")
            echo "GOOS=openbsd" >> $GITHUB_ENV
            echo "GOARCH=amd64" >> $GITHUB_ENV
            ;;
          "openbsd-arm64")
            echo "GOOS=openbsd" >> $GITHUB_ENV
            echo "GOARCH=arm64" >> $GITHUB_ENV
            ;;
        esac

    - name: Build binary
      run: |
        mkdir -p dist
        BINARY_NAME="airtruct"
        if [ "$GOOS" = "windows" ]; then
          BINARY_NAME="${BINARY_NAME}.exe"
        fi
        
        CGO_ENABLED=0 go build \
          -ldflags="-s -w -X main.Version=${{ github.ref_name }} -X main.DateBuilt=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
          -o "dist/${BINARY_NAME}" \
          ./cmd/airtruct

    - name: Create archive
      run: |
        cd dist
        ARCHIVE_NAME="airtruct_${{ github.ref_name }}_${GOOS}_${GOARCH}"
        if [ -n "$GOARM" ]; then
          ARCHIVE_NAME="${ARCHIVE_NAME}v${GOARM}"
        fi
        
        # Copy README and LICENSE to current directory
        cp ../README.md ../LICENSE ./
        
        if [ "$GOOS" = "windows" ]; then
          zip "${ARCHIVE_NAME}.zip" airtruct.exe README.md LICENSE
        else
          tar -czf "${ARCHIVE_NAME}.tar.gz" airtruct README.md LICENSE
        fi
        
        # Clean up copied files
        rm -f README.md LICENSE

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: airtruct-${{ matrix.build_group }}
        path: dist/*.tar.gz dist/*.zip
        retention-days: 1

  create-release:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Check Out Repo
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        find artifacts/ -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} release-assets/ \;
        echo "Found artifacts:"
        ls -la release-assets/

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: release-assets/*
        tag_name: ${{ github.ref_name }}
        name: ${{ github.ref_name }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:

    - name: Check Out Repo
      uses: actions/checkout@v4

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Install Buildx
      id: buildx
      uses: docker/setup-buildx-action@v3

    - name: Docker meta
      id: docker_meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ghcr.io/${{ github.repository_owner }}/airtruct
        tags: |
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}

    - name: Build and push
      uses: docker/build-push-action@v6
      with:
        context: ./
        file: Dockerfile
        builder: ${{ steps.buildx.outputs.name }}
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.docker_meta.outputs.tags }}
        cache-from: type=gha
        cache-to: type=gha,mode=max